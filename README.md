**The application - Step 1**
=============================

### Prerequisites: ###
1. **You need to have .NET installed on your machine. On macOs, you can install it from here https://learn.microsoft.com/en-us/dotnet/core/install/macos**
2. **You need to install an IDE, I used Visual Studio Code. You can get it from here: https://code.visualstudio.com/download**

I created a GitHub Action worflow for continous integration CI:

In your Github, fork my repository: https://github.com/biancapistea/webApi.git or put the .zip file on a github repository.

Make a change in the code to see that the pipeline is working (codeql pipeline) which contains 2 steps: first, it verifies the code (linting) and then build the app

**The custom image - Step 2**
=============================

### Prerequisites: ###

1. **Make sure that you have packer installed, if you are on a macOs/linux you can install using brew install packer**
2. **You can verify that is installed by writing packer in your terminal.**
3. **Make sure that you have an AWS account**
    1. Go to the AWS website (https://aws.amazon.com/).
    2. Click on the "Create an AWS Account" button.
    3. Follow the on-screen instructions to create your AWS account. You will need to provide your email address, create a password, and enter some personal information.
    4. Provide Payment Information
    5. Access Your AWS Management Console - Once your account is set up and verified, log in to the AWS Management Console using your newly created credentials.
    6. Generate Access Key ID and Secret Access Key
    7. In the AWS Management Console, navigate to the IAM (Identity and Access Management) service.
    8. Click on "Users" in the left navigation pane and then click on "Add user."
    9. Enter a username for the new user and select "Programmatic access" as the access type.
    10. Proceed to the permissions step and attach policies that grant the necessary permissions to the user. For example, you can attach the "AdministratorAccess" policy for full administrative access, or you can create custom policies.
    11. Review the user details and create the user - Once created, you will see the Access Key ID and Secret Access Key. Be sure to copy these credentials as they are only displayed once. If you lose them, you will need to generate a new pair.
    12. Use AWS Credentials in your applications


### There are 2 files for building images: ####

**windows.json.pkr.hcl** -> This Packer template is used to create a custom Amazon Machine Image (AMI) on AWS using the Amazon Elastic Block Store (EBS) service. It installs the prerequisites needed for the Windows Virtual Machine Image to run the .NET application created. 

If you want to run it locally, on your machine, you first need to export the variables needed:
```
export AWS_SECRET_ACCESS_KEY=“INSERT HERE YOUR AWS_SECRET_ACCESS_KEY from aws” 
export AWS_ACCESS_KEY="INSERT HERE YOUR AWS_ACCESS_KEY from aws” 
export AWS_REGION=“INSERT HERE YOUR REGION from aws”
``` 
Then, you can run it using: `packer build windows.json.pkr.hcl`

**The following will appear, if it’s successful:**
```
amazon-ebs.autogenerated_1: output will be in this color.

==> amazon-ebs.autogenerated_1: Prevalidating any provided VPC information
==> amazon-ebs.autogenerated_1: Prevalidating AMI Name: packer prerequisites 20240417131326
    amazon-ebs.autogenerated_1: Found Image ID: ami-0381840963c35cb1f
==> amazon-ebs.autogenerated_1: Creating temporary keypair: packer_661fcaf6-10da-5e84-d5da-966e4793050d
==> amazon-ebs.autogenerated_1: Creating temporary security group for this instance: packer_661fcaf7-e2f8-e48c-d1ad-95be947d089d
==> amazon-ebs.autogenerated_1: Authorizing access to port 5985 from [0.0.0.0/0] in the temporary security groups...
==> amazon-ebs.autogenerated_1: Launching a source AWS instance...
    amazon-ebs.autogenerated_1: Instance ID: i-0c82da0f924d1b675
==> amazon-ebs.autogenerated_1: Waiting for instance (i-0c82da0f924d1b675) to become ready...
==> amazon-ebs.autogenerated_1: Skipping waiting for password since WinRM password set...
==> amazon-ebs.autogenerated_1: Using WinRM communicator to connect: 3.70.95.151
==> amazon-ebs.autogenerated_1: Waiting for WinRM to become available...
    amazon-ebs.autogenerated_1: WinRM connected.
==> amazon-ebs.autogenerated_1: Connected to WinRM!
==> amazon-ebs.autogenerated_1: Provisioning with Powershell...
==> amazon-ebs.autogenerated_1: Provisioning with powershell script: ./prerequisites.ps1
    amazon-ebs.autogenerated_1: dotnet-install: Downloaded file https://dotnetcli.azureedge.net/dotnet/aspnetcore/Runtime/8.0.4/aspnetcore-runtime-8.0.4-win-x64.zip size is 45277777 bytes.
    amazon-ebs.autogenerated_1: dotnet-install: Either downloaded or local package size can not be measured. One of them may be corrupted.
    amazon-ebs.autogenerated_1: dotnet-install: Extracting the archive.
    amazon-ebs.autogenerated_1: dotnet-install: Adding to current process PATH: "C:\Users\Administrator\AppData\Local\Microsoft\dotnet\". Note: This change will not be visible if PowerShell was run as a child process.
    amazon-ebs.autogenerated_1: dotnet-install: Note that the script does not resolve dependencies during installation.
    amazon-ebs.autogenerated_1: dotnet-install: To check the list of dependencies, go to https://learn.microsoft.com/dotnet/core/install/windows#dependencies
    amazon-ebs.autogenerated_1: dotnet-install: Installed version is 8.0.4
    amazon-ebs.autogenerated_1: dotnet-install: Installation finished
    amazon-ebs.autogenerated_1: dotnet-install: Downloaded file https://dotnetcli.azureedge.net/dotnet/Sdk/8.0.204/dotnet-sdk-8.0.204-win-x64.zip size is 294676060 bytes.
    amazon-ebs.autogenerated_1: dotnet-install: Either downloaded or local package size can not be measured. One of them may be corrupted.
    amazon-ebs.autogenerated_1: dotnet-install: Extracting the archive.
    amazon-ebs.autogenerated_1: dotnet-install: Note that the script does not resolve dependencies during installation.
    amazon-ebs.autogenerated_1: dotnet-install: To check the list of dependencies, go to https://learn.microsoft.com/dotnet/core/install/windows#dependencies
    amazon-ebs.autogenerated_1: dotnet-install: Installed version is 8.0.204
    amazon-ebs.autogenerated_1: dotnet-install: Installation finished
    amazon-ebs.autogenerated_1: 4.8.03761
    amazon-ebs.autogenerated_1:
    amazon-ebs.autogenerated_1: Success Restart Needed Exit Code      Feature Result
    amazon-ebs.autogenerated_1: ------- -------------- ---------      --------------
    amazon-ebs.autogenerated_1: True    No             Success        {Common HTTP Features, Default Document, D...
    amazon-ebs.autogenerated_1: True    No             Success        {ASP.NET 4.7, Management Service}
==> amazon-ebs.autogenerated_1: Stopping the source instance...
    amazon-ebs.autogenerated_1: Stopping instance
==> amazon-ebs.autogenerated_1: Waiting for the instance to stop...
==> amazon-ebs.autogenerated_1: Creating AMI packer prerequisites 20240417131326 from instance i-0c82da0f924d1b675
    amazon-ebs.autogenerated_1: AMI: ami-095275493b7887845
==> amazon-ebs.autogenerated_1: Waiting for AMI to become ready...
==> amazon-ebs.autogenerated_1: Skipping Enable AMI deprecation...
==> amazon-ebs.autogenerated_1: Terminating the source AWS instance...
==> amazon-ebs.autogenerated_1: Cleaning up any extra volumes...
==> amazon-ebs.autogenerated_1: No volumes to clean up, skipping
==> amazon-ebs.autogenerated_1: Deleting temporary security group...
==> amazon-ebs.autogenerated_1: Deleting temporary keypair...
==> amazon-ebs.autogenerated_1: Running post-processor:  (type manifest)
Build 'amazon-ebs.autogenerated_1' finished after 20 minutes 34 seconds.
```

Then, you can enter to your AWS account, on EC2, you can see your instance running and your images created by the instance:
<img width="1512" alt="Screenshot 2024-04-17 at 18 30 51" src="https://github.com/biancapistea/webApi/assets/56589178/e81f0cc7-dd92-492c-879d-c32d67f72e7b">


**windows-app.json.pkr.hcl** -> This Packer template is used to create another Amazon Machine Image (AMI) on AWS, specifically for installing the .NET application on Windows Server Image created by the packer using **windows.json.pkr.hcl**.

If you want to run it **locally**, on your machine, you will not need to export again the variables, but you need the prerequisites_ami which is the AMI ID of the previous created image (the prerequisites image). 

In order to find the AMI ID, you first need to install, if you are on a macOS: brew install jq

Then, you need to use this command: `packer build -var "prerequisites_ami=$(jq -r '.builds[-1].artifact_id' prerequisites_ami.json | cut -d ':' -f2)" windows-app.json.pkr.hcl` 

This command will search in **prerequisites_ami.json** the last created build, based on artifact_id from which it splits the string and takes the second argument which is the AMI ID.

**prerequisites_ami.json** -> it's a file that is generated by the post-processor in **windows.json.pkr.hcl**.:  
```
post-processor "manifest" {
    output = "prerequisites_ami.json"
    strip_path = true
  }
```

**The following logs will appear, if it’s successful:**
```
amazon-ebs.autogenerated_1: output will be in this color.

==> amazon-ebs.autogenerated_1: Prevalidating any provided VPC information
==> amazon-ebs.autogenerated_1: Prevalidating AMI Name: packer application 20240417134040
    amazon-ebs.autogenerated_1: Found Image ID: ami-095275493b7887845
==> amazon-ebs.autogenerated_1: Creating temporary keypair: packer_661fd158-358f-c6bb-0ec8-e6f1f7a06f7f
==> amazon-ebs.autogenerated_1: Creating temporary security group for this instance: packer_661fd159-8659-a2ac-fcec-bb142b6cd067
==> amazon-ebs.autogenerated_1: Authorizing access to port 5985 from [0.0.0.0/0] in the temporary security groups...
==> amazon-ebs.autogenerated_1: Launching a source AWS instance...
    amazon-ebs.autogenerated_1: Instance ID: i-032808045515c0df3
==> amazon-ebs.autogenerated_1: Waiting for instance (i-032808045515c0df3) to become ready...
==> amazon-ebs.autogenerated_1: Skipping waiting for password since WinRM password set...
==> amazon-ebs.autogenerated_1: Using WinRM communicator to connect: 3.76.105.57
==> amazon-ebs.autogenerated_1: Waiting for WinRM to become available...
    amazon-ebs.autogenerated_1: WinRM connected.
==> amazon-ebs.autogenerated_1: Connected to WinRM!
==> amazon-ebs.autogenerated_1: Provisioning with Powershell...
==> amazon-ebs.autogenerated_1: Provisioning with powershell script: ./application.ps1
    amazon-ebs.autogenerated_1:
    amazon-ebs.autogenerated_1:
    amazon-ebs.autogenerated_1:     Directory: C:\
    amazon-ebs.autogenerated_1:
    amazon-ebs.autogenerated_1:
    amazon-ebs.autogenerated_1: Mode                LastWriteTime         Length Name
    amazon-ebs.autogenerated_1: ----                -------------         ------ ----
    amazon-ebs.autogenerated_1: d-----        4/17/2024   1:42 PM                DotNetApp
==> amazon-ebs.autogenerated_1: Cloning into 'C:\DotNetApp'...
    amazon-ebs.autogenerated_1:
    amazon-ebs.autogenerated_1: Welcome to .NET 8.0!
    amazon-ebs.autogenerated_1: ---------------------
    amazon-ebs.autogenerated_1: SDK Version: 8.0.204
    amazon-ebs.autogenerated_1:
    amazon-ebs.autogenerated_1: Telemetry
    amazon-ebs.autogenerated_1: ---------
    amazon-ebs.autogenerated_1: The .NET tools collect usage data in order to help us improve your experience. It is collected by Microsoft and shared with the community. You can opt-out of telemetry by setting the DOTNET_CLI_TELEMETRY_OPTOUT environment variable to '1' or 'true' using your favorite shell.
    amazon-ebs.autogenerated_1:
    amazon-ebs.autogenerated_1: Read more about .NET CLI Tools telemetry: https://aka.ms/dotnet-cli-telemetry
    amazon-ebs.autogenerated_1:
    amazon-ebs.autogenerated_1: ----------------
    amazon-ebs.autogenerated_1: Installed an ASP.NET Core HTTPS development certificate.
    amazon-ebs.autogenerated_1: To trust the certificate, run 'dotnet dev-certs https --trust'
    amazon-ebs.autogenerated_1: Learn about HTTPS: https://aka.ms/dotnet-https
    amazon-ebs.autogenerated_1:
    amazon-ebs.autogenerated_1: ----------------
    amazon-ebs.autogenerated_1: Write your first app: https://aka.ms/dotnet-hello-world
    amazon-ebs.autogenerated_1: Find out what's new: https://aka.ms/dotnet-whats-new
    amazon-ebs.autogenerated_1: Explore documentation: https://aka.ms/dotnet-docs
    amazon-ebs.autogenerated_1: Report issues and find source on GitHub: https://github.com/dotnet/core
    amazon-ebs.autogenerated_1: Use 'dotnet --help' to see available commands or visit: https://aka.ms/dotnet-cli
    amazon-ebs.autogenerated_1: --------------------------------------------------------------------------------------
    amazon-ebs.autogenerated_1: MSBuild version 17.9.8+b34f75857 for .NET
    amazon-ebs.autogenerated_1:   Determining projects to restore...
    amazon-ebs.autogenerated_1:   Restored C:\DotNetApp\webApi.csproj (in 165 ms).
    amazon-ebs.autogenerated_1: C:\DotNetApp\Program.cs(3,5): warning CS0219: The variable 'x' is assigned but its value is never used [C:\DotNetApp\webApi.csproj]
    amazon-ebs.autogenerated_1: C:\DotNetApp\Program.cs(4,5): warning CS0219: The variable 'ys' is assigned but its value is never used [C:\DotNetApp\webApi.csproj]
    amazon-ebs.autogenerated_1: C:\DotNetApp\Program.cs(5,5): warning CS0219: The variable 'fd' is assigned but its value is never used [C:\DotNetApp\webApi.csproj]
    amazon-ebs.autogenerated_1: C:\DotNetApp\Program.cs(6,5): warning CS0219: The variable 'd' is assigned but its value is never used [C:\DotNetApp\webApi.csproj]
    amazon-ebs.autogenerated_1:   webApi -> C:\DotNetApp\bin\Debug\net8.0\webApi.dll
    amazon-ebs.autogenerated_1:
    amazon-ebs.autogenerated_1: Build succeeded.
    amazon-ebs.autogenerated_1:
    amazon-ebs.autogenerated_1: C:\DotNetApp\Program.cs(3,5): warning CS0219: The variable 'x' is assigned but its value is never used [C:\DotNetApp\webApi.csproj]
    amazon-ebs.autogenerated_1: C:\DotNetApp\Program.cs(4,5): warning CS0219: The variable 'ys' is assigned but its value is never used [C:\DotNetApp\webApi.csproj]
    amazon-ebs.autogenerated_1: C:\DotNetApp\Program.cs(5,5): warning CS0219: The variable 'fd' is assigned but its value is never used [C:\DotNetApp\webApi.csproj]
    amazon-ebs.autogenerated_1: C:\DotNetApp\Program.cs(6,5): warning CS0219: The variable 'd' is assigned but its value is never used [C:\DotNetApp\webApi.csproj]
    amazon-ebs.autogenerated_1:     4 Warning(s)
    amazon-ebs.autogenerated_1:     0 Error(s)
    amazon-ebs.autogenerated_1:
    amazon-ebs.autogenerated_1: Time Elapsed 00:01:03.42
==> amazon-ebs.autogenerated_1: Stopping the source instance...
    amazon-ebs.autogenerated_1: Stopping instance
==> amazon-ebs.autogenerated_1: Waiting for the instance to stop...
==> amazon-ebs.autogenerated_1: Creating AMI packer application 20240417134040 from instance i-032808045515c0df3
    amazon-ebs.autogenerated_1: AMI: ami-0dd63d67cdb75ab06
==> amazon-ebs.autogenerated_1: Waiting for AMI to become ready...
==> amazon-ebs.autogenerated_1: Skipping Enable AMI deprecation...
==> amazon-ebs.autogenerated_1: Terminating the source AWS instance...
==> amazon-ebs.autogenerated_1: Cleaning up any extra volumes...
==> amazon-ebs.autogenerated_1: No volumes to clean up, skipping
==> amazon-ebs.autogenerated_1: Deleting temporary security group...
==> amazon-ebs.autogenerated_1: Deleting temporary keypair...

Build 'amazon-ebs.autogenerated_1' finished after 7 minutes 857 milliseconds.
```

If you want to run from github, commit a modification and the pipelines will start automatically and it will create the images. You can see the images in your AWS account, on EC2 console.



